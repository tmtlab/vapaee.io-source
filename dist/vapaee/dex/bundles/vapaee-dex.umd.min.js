!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@vapaee/scatter"),require("bignumber.js"),require("@angular/core"),require("rxjs"),require("ngx-cookie-service"),require("@angular/common"),require("@vapaee/feedback"),require("ngx-cookie-service/cookie-service/cookie.service")):"function"==typeof define&&define.amd?define("@vapaee/dex",["exports","@vapaee/scatter","bignumber.js","@angular/core","rxjs","ngx-cookie-service","@angular/common","@vapaee/feedback","ngx-cookie-service/cookie-service/cookie.service"],t):t((e.vapaee=e.vapaee||{},e.vapaee.dex={}),null,null,e.ng.core,e.rxjs,null,e.ng.common,null,null)}(this,function(e,t,I,o,n,r,s,i,a){"use strict";I=I&&I.hasOwnProperty("default")?I["default"]:I;var u=function(e,t){return(u=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])})(e,t)};function c(e,t){function o(){this.constructor=e}u(e,t),e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)}function d(t,i,a,u){return new(a||(a=Promise))(function(e,o){function r(e){try{n(u.next(e))}catch(t){o(t)}}function s(e){try{n(u["throw"](e))}catch(t){o(t)}}function n(t){t.done?e(t.value):new a(function(e){e(t.value)}).then(r,s)}n((u=u.apply(t,i||[])).next())})}function G(r,s){var n,i,a,e,u={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return e={next:t(0),"throw":t(1),"return":t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function o(e){if(n)throw new TypeError("Generator is already executing.");for(;u;)try{if(n=1,i&&(a=2&e[0]?i["return"]:e[0]?i["throw"]||((a=i["return"])&&a.call(i),0):i.next)&&!(a=a.call(i,e[1])).done)return a;switch(i=0,a&&(e=[2&e[0],a.value]),e[0]){case 0:case 1:a=e;break;case 4:return u.label++,{value:e[1],done:!1};case 5:u.label++,i=e[1],e=[0];continue;case 7:e=u.ops.pop(),u.trys.pop();continue;default:if(!(a=0<(a=u.trys).length&&a[a.length-1])&&(6===e[0]||2===e[0])){u=0;continue}if(3===e[0]&&(!a||e[1]>a[0]&&e[1]<a[3])){u.label=e[1];break}if(6===e[0]&&u.label<a[1]){u.label=a[1],a=e;break}if(a&&u.label<a[2]){u.label=a[2],u.ops.push(e);break}a[2]&&u.ops.pop(),u.trys.pop();continue}e=s.call(r,u)}catch(t){e=[6,t],i=0}finally{n=a=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([t,e])}}}var l=function(o){function e(e){void 0===e&&(e=null);var t=o.call(this,e)||this;return"object"==typeof e&&(delete e.symbol,delete e.precision,delete e.contract,Object.assign(t,e)),t.toString(),t}return c(e,o),e}(t.Token),z=function(r){function s(e,t){void 0===e&&(e=null),void 0===t&&(t=null);var o=r.call(this,e,t)||this;return e instanceof s?(o.amount=e.amount,o.token=t):t&&t.getTokenNow&&o.parseDex(e,t),o}return c(s,r),s.prototype.clone=function(){return new s(this.amount,this.token)},s.prototype.plus=function(e){return console.assert(!!e,"ERROR: b is not an Asset",e,this.str),console.assert(e.token.symbol==this.token.symbol,"ERROR: trying to sum assets with different tokens: "+this.str+" and "+e.str),new s(this.amount.plus(e.amount),this.token)},s.prototype.minus=function(e){return console.assert(!!e,"ERROR: b is not an Asset",e,this.str),console.assert(e.token.symbol==this.token.symbol,"ERROR: trying to substract assets with different tokens: "+this.str+" and "+e.str),new s(this.amount.minus(e.amount),this.token)},s.prototype.parseDex=function(e,t){if(""!=e){var o=e.split(" ")[1];this.token=t.getTokenNow(o);var r=e.split(" ")[0];this.amount=new I(r)}},s.prototype.toString=function(e){return void 0===e&&(e=-1),this.token?this.valueToString(e)+" "+this.token.symbol.toUpperCase():"0.0000"},s.prototype.inverse=function(e){return new s(new I(1).dividedBy(this.amount),e)},s}(t.Asset),h=function(){function e(e,t,o){var r,s=this;this.scatter=e,this.cookies=t,this.datePipe=o,this.onLoggedAccountChange=new n.Subject,this.onCurrentAccountChange=new n.Subject,this.onHistoryChange=new n.Subject,this.onMarketSummary=new n.Subject,this.onTokensReady=new n.Subject,this.onMarketReady=new n.Subject,this.onTradeUpdated=new n.Subject,this.vapaeetokens="vapaeetokens",this.activityPagesize=10,this.waitOrderSummary=new Promise(function(e){s.setOrderSummary=e}),this.waitTokenStats=new Promise(function(e){s.setTokenStats=e}),this.waitMarketSummary=new Promise(function(e){s.setMarketSummary=e}),this.waitTokenSummary=new Promise(function(e){s.setTokenSummary=e}),this.waitTokensLoaded=new Promise(function(e){s.setTokensLoaded=e}),this._markets={},this._reverse={},this.activity={total:0,events:{},list:[]},this.current=this["default"],this.contract_name=this.vapaeetokens,this.contract=this.scatter.getSmartContract(this.contract_name),this.feed=new i.Feedback,this.scatter.onLogggedStateChange.subscribe(this.onLoggedChange.bind(this)),this.updateLogState(),this.fetchTokens().then(function(e){s.tokens=e.tokens,s.tokens.push(new l({appname:"Viitasphere",contract:"viitasphere1",logo:"/assets/logos/viitasphere.png",logolg:"/assets/logos/viitasphere-lg.png",precision:4,scope:"viitct.tlos",symbol:"VIITA",verified:!1,website:"https://viitasphere.com"})),s.tokens.push(new l({appname:"Viitasphere",contract:"viitasphere1",logo:"/assets/logos/viitasphere.png",logolg:"/assets/logos/viitasphere-lg.png",precision:0,scope:"viitct.tlos",symbol:"VIICT",verified:!1,website:"https://viitasphere.com"})),s.zero_telos=new z("0.0000 TLOS",s),s.setTokensLoaded(),s.fetchTokensStats(),s.getOrderSummary(),s.getAllTablesSumaries()}),this.onMarketSummary.subscribe(function(e){clearTimeout(r),r=setTimeout(function(e){s.updateTokensSummary(),s.updateTokensMarkets()},100)})}return Object.defineProperty(e.prototype,"default",{get:function(){return this.scatter["default"]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"logged",{get:function(){return this.scatter.logged&&this.scatter.account,this.scatter.logged?this.scatter.account?this.scatter.account.name:this.scatter["default"].name:null},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"account",{get:function(){return this.scatter.logged?this.scatter.account:this.scatter["default"]},enumerable:!0,configurable:!0}),e.prototype.login=function(){var t=this;return this.feed.setLoading("login",!0),this.feed.setLoading("log-state",!0),console.log("VapaeeDEX.login() this.feed.loading('log-state')",this.feed.loading("log-state")),this.logout(),this.updateLogState(),console.log("VapaeeDEX.login() this.feed.loading('log-state')",this.feed.loading("log-state")),this.feed.setLoading("logout",!1),this.scatter.login().then(function(){t.updateLogState(),t.feed.setLoading("login",!1)})["catch"](function(e){throw t.feed.setLoading("login",!1),e})},e.prototype.logout=function(){this.feed.setLoading("logout",!0),this.scatter.logout()},e.prototype.onLogout=function(){var t=this;this.feed.setLoading("logout",!1),console.log("VapaeeDEX.onLogout()"),this.resetCurrentAccount(this["default"].name),this.updateLogState(),this.onLoggedAccountChange.next(this.logged),this.cookies["delete"]("login"),setTimeout(function(e){t.last_logged=t.logged},400)},e.prototype.onLogin=function(e){console.log("VapaeeDEX.onLogin()",e),this.resetCurrentAccount(e),this.getDeposits(),this.getBalances(),this.updateLogState(),this.getUserOrders(),this.onLoggedAccountChange.next(this.logged),this.last_logged=this.logged,this.cookies.set("login",this.logged)},e.prototype.onLoggedChange=function(){console.log("VapaeeDEX.onLoggedChange()"),this.scatter.logged?this.onLogin(this.scatter.account.name):this.onLogout()},e.prototype.resetCurrentAccount=function(o){return d(this,void 0,void 0,function(){var t;return G(this,function(e){switch(e.label){case 0:return console.log("VapaeeDEX.resetCurrentAccount()",this.current.name,"->",o),this.current.name==o||this.current.name!=this.last_logged&&"guest"==o?[3,4]:(this.feed.setLoading("account",!0),this.current=this["default"],"guest"==(this.current.name=o)?[3,2]:(t=this.current,[4,this.getAccountData(this.current.name)]));case 1:return t.data=e.sent(),[3,3];case 2:console.error("------------------------------------------"),console.error("------------------------------------------"),console.error("WARNING!!! current is guest",[o,this.account,this.current]),console.error("------------------------------------------"),console.error("------------------------------------------"),e.label=3;case 3:this.balances=[],this.userorders={},this.onCurrentAccountChange.next(this.current.name),this.updateCurrentUser(),this.feed.setLoading("account",!1),e.label=4;case 4:return[2]}})})},e.prototype.updateLogState=function(){var t,o=this;this.loginState="no-scatter",this.feed.setLoading("log-state",!0),console.log("VapaeeDEX.updateLogState() ",this.loginState,this.feed.loading("log-state")),this.scatter.waitConnected.then(function(){o.loginState="no-logged",o.scatter.logged&&(o.loginState="account-ok"),o.feed.setLoading("log-state",!1),console.log("VapaeeDEX.updateLogState() ",o.loginState,o.feed.loading("log-state"))});var r=setInterval(function(e){o.scatter.feed.loading("connect")||(o.feed.setLoading("log-state",!1),clearInterval(r),clearInterval(t))},200);t=setTimeout(function(e){clearInterval(r),o.feed.setLoading("log-state",!1)},6e3)},e.prototype.getAccountData=function(o){return d(this,void 0,void 0,function(){var t=this;return G(this,function(e){return[2,this.scatter.queryAccountData(o)["catch"](function(e){return d(t,void 0,void 0,function(){return G(this,function(e){return[2,this["default"].data]})})})]})})},e.prototype.createOrder=function(o,r,s){var n=this;return this.feed.setLoading("order-"+o,!0),this.contract.excecute("order",{owner:this.scatter.account.name,type:o,total:r.toString(8),price:s.toString(8)}).then(function(t){return d(n,void 0,void 0,function(){return G(this,function(e){return this.updateTrade(r.token,s.token),this.feed.setLoading("order-"+o,!1),[2,t]})})})["catch"](function(e){throw n.feed.setLoading("order-"+o,!1),console.error(e),e})},e.prototype.cancelOrder=function(r,s,n,i){var a=this;for(var e in this.feed.setLoading("cancel-"+r,!0),i)this.feed.setLoading("cancel-"+r+"-"+i[e],!0);return this.contract.excecute("cancel",{owner:this.scatter.account.name,type:r,comodity:s.symbol,currency:n.symbol,orders:i}).then(function(o){return d(a,void 0,void 0,function(){var t;return G(this,function(e){for(t in this.updateTrade(s,n),this.feed.setLoading("cancel-"+r,!1),i)this.feed.setLoading("cancel-"+r+"-"+i[t],!1);return[2,o]})})})["catch"](function(e){for(var t in a.feed.setLoading("cancel-"+r,!1),i)a.feed.setLoading("cancel-"+r+"-"+i[t],!1);throw console.error(e),e})},e.prototype.deposit=function(o){var r=this,e=this.scatter.getSmartContract(o.token.contract);return this.feed.setError("deposit",null),this.feed.setLoading("deposit",!0),this.feed.setLoading("deposit-"+o.token.symbol.toLowerCase(),!0),e.excecute("transfer",{from:this.scatter.account.name,to:this.vapaeetokens,quantity:o.toString(),memo:"deposit"}).then(function(t){return d(r,void 0,void 0,function(){return G(this,function(e){return this.feed.setLoading("deposit",!1),this.feed.setLoading("deposit-"+o.token.symbol.toLowerCase(),!1),this.getDeposits(),this.getBalances(),[2,t]})})})["catch"](function(e){throw r.feed.setLoading("deposit",!1),r.feed.setLoading("deposit-"+o.token.symbol.toLowerCase(),!1),r.feed.setError("deposit","string"==typeof e?e:JSON.stringify(e,null,4)),console.error(e),e})},e.prototype.withdraw=function(o){var r=this;return this.feed.setError("withdraw",null),this.feed.setLoading("withdraw",!0),this.feed.setLoading("withdraw-"+o.token.symbol.toLowerCase(),!0),this.contract.excecute("withdraw",{owner:this.scatter.account.name,quantity:o.toString()}).then(function(t){return d(r,void 0,void 0,function(){return G(this,function(e){return this.feed.setLoading("withdraw",!1),this.feed.setLoading("withdraw-"+o.token.symbol.toLowerCase(),!1),this.getDeposits(),this.getBalances(),[2,t]})})})["catch"](function(e){throw r.feed.setLoading("withdraw",!1),r.feed.setLoading("withdraw-"+o.token.symbol.toLowerCase(),!1),r.feed.setError("withdraw","string"==typeof e?e:JSON.stringify(e,null,4)),e})},e.prototype.addOffChainToken=function(t){var o=this;this.waitTokensLoaded.then(function(e){o.tokens.push(new l({symbol:t.symbol,precision:t.precision||4,contract:"nocontract",appname:t.appname,website:"",logo:"",logolg:"",scope:"",stat:null,verified:!1,offchain:!0}))})},e.prototype.hasScopes=function(){return!!this._markets},e.prototype.market=function(e){if(this._markets[e])return this._markets[e];var t=this.inverseScope(e);return this._reverse[t]?this._reverse[t]:this._markets[t]?this.reverse(e):null},e.prototype.table=function(e){return this.market(e)},e.prototype.reverse=function(e){var t=this.canonicalScope(e),o=this.inverseScope(t);return console.assert(t!=o,"ERROR: ",t,o),!this._reverse[o]&&this._markets[t]&&(this._reverse[o]=this.createReverseTableFor(o)),this._reverse[o]},e.prototype.marketFor=function(e,t){var o=this.getScopeFor(e,t);return this.table(o)},e.prototype.tableFor=function(e,t){return console.error("tableFor()",e.symbol,t.symbol," DEPRECATED"),this.marketFor(e,t)},e.prototype.createReverseTableFor=function(e){var t=this.canonicalScope(e),o=this.inverseScope(t),r=this._markets[t],s=[];for(var n in r.history){var i={id:r.history[n].id,str:"",price:r.history[n].inverse.clone(),inverse:r.history[n].price.clone(),amount:r.history[n].payment.clone(),payment:r.history[n].amount.clone(),buyer:r.history[n].seller,seller:r.history[n].buyer,buyfee:r.history[n].sellfee.clone(),sellfee:r.history[n].buyfee.clone(),date:r.history[n].date,isbuy:!r.history[n].isbuy};i.str=i.price.str+" "+i.amount.str,s.push(i)}var a={buy:[],sell:[]};for(var u in{buy:"buy",sell:"sell"}){var c,l;for(var n in r.orders[u]){var h=r.orders[u][n];c=[];for(var m=0;m<h.orders.length;m++)l={deposit:h.orders[m].deposit.clone(),id:h.orders[m].id,inverse:h.orders[m].price.clone(),price:h.orders[m].inverse.clone(),owner:h.orders[m].owner,telos:h.orders[m].total,total:h.orders[m].telos},c.push(l);var d={inverse:h.price.clone(),orders:c,owners:h.owners,price:h.inverse.clone(),str:h.inverse.str,sum:h.sumtelos.clone(),sumtelos:h.sum.clone(),telos:h.total.clone(),total:h.telos.clone()};a[u].push(d)}}return{scope:o,comodity:r.currency,currency:r.comodity,block:r.block,blocklist:r.reverseblocks,reverseblocks:r.blocklist,blocklevels:r.reverselevels,reverselevels:r.blocklevels,blocks:r.blocks,deals:r.deals,header:{sell:{total:r.header.buy.total.clone(),orders:r.header.buy.orders},buy:{total:r.header.sell.total.clone(),orders:r.header.sell.orders}},history:s,orders:{sell:a.buy,buy:a.sell},summary:{scope:this.inverseScope(r.summary.scope),price:r.summary.inverse,price_24h_ago:r.summary.inverse_24h_ago,inverse:r.summary.price,inverse_24h_ago:r.summary.price_24h_ago,max_inverse:r.summary.max_price,max_price:r.summary.max_inverse,min_inverse:r.summary.min_price,min_price:r.summary.min_inverse,records:r.summary.records,volume:r.summary.amount,amount:r.summary.volume,percent:r.summary.ipercent,ipercent:r.summary.percent,percent_str:r.summary.ipercent_str,ipercent_str:r.summary.percent_str},tx:r.tx}},e.prototype.getScopeFor=function(e,t){return e&&t?e.symbol.toLowerCase()+"."+t.symbol.toLowerCase():""},e.prototype.inverseScope=function(e){if(!e)return e;console.assert("string"==typeof e,"ERROR: string scope expected, got ",typeof e,e);var t=e.split(".");return console.assert(2==t.length,"ERROR: scope format expected is xxx.yyy, got: ",typeof e,e),t[1]+"."+t[0]},e.prototype.canonicalScope=function(e){if(!e)return e;console.assert("string"==typeof e,"ERROR: string scope expected, got ",typeof e,e);var t=e.split(".");console.assert(2==t.length,"ERROR: scope format expected is xxx.yyy, got: ",typeof e,e);var o=t[1]+"."+t[0];return"tlos"==t[1]?e:"tlos"==t[0]?o:t[0]<t[1]?e:o},e.prototype.isCanonical=function(e){return this.canonicalScope(e)==e},e.prototype.getBalance=function(e){for(var t in this.balances)if(this.balances[t].token.symbol==e.symbol)return this.balances[t];return new z("0 "+e.symbol,this)},e.prototype.getSomeFreeFakeTokens=function(c){return void 0===c&&(c=null),d(this,void 0,void 0,function(){var a,u=this;return G(this,function(e){return console.log("VapaeeDEX.getSomeFreeFakeTokens()"),a=c,this.feed.setLoading("freefake-"+a||"token",!0),[2,this.waitTokenStats.then(function(e){for(var t=null,o=0;o<100;o++){c&&u.tokens[o].symbol==c&&(t=u.tokens[o]);var r=Math.random();if(!t&&.5<r&&((t=u.tokens[o%u.tokens.length]).fake?.5<(r=Math.random())&&(t=u.telos):t=null),o<100&&t&&0<u.getBalance(t).amount.toNumber()&&(t=null),t){r=Math.random();var s=Math.floor(1e4*r)/100,n=new z(s+" "+t.symbol,u),i="you get "+n.valueToString()+" free fake "+t.symbol+" tokens to play on vapaee.io DEX";return u.contract.excecute("issue",{to:u.scatter.account.name,quantity:n.toString(),memo:i}).then(function(e){return u.getBalances(),u.feed.setLoading("freefake-"+a||"token",!1),i})["catch"](function(e){throw u.feed.setLoading("freefake-"+a||"token",!1),e})}}})]})})},e.prototype.getTokenNow=function(e){if(!e)return null;for(var t in this.tokens)if(("TLOS"!=this.tokens[t].symbol.toUpperCase()||!this.tokens[t].offchain)&&this.tokens[t].symbol.toUpperCase()==e.toUpperCase())return this.tokens[t];return null},e.prototype.getToken=function(o){return d(this,void 0,void 0,function(){var t=this;return G(this,function(e){return[2,this.waitTokensLoaded.then(function(e){return t.getTokenNow(o)})]})})},e.prototype.getDeposits=function(s){return void 0===s&&(s=null),d(this,void 0,void 0,function(){var t=this;return G(this,function(e){return console.log("VapaeeDEX.getDeposits()"),this.feed.setLoading("deposits",!0),[2,this.waitTokensLoaded.then(function(e){return d(t,void 0,void 0,function(){var t,o,r;return G(this,function(e){switch(e.label){case 0:return t=[],!s&&this.current.name&&(s=this.current.name),s?[4,this.fetchDeposits(s)]:[3,2];case 1:for(r in(o=e.sent()).rows)t.push(new z(o.rows[r].amount,this));e.label=2;case 2:return this.deposits=t,this.feed.setLoading("deposits",!1),[2,this.deposits]}})})})]})})},e.prototype.getBalances=function(o){return void 0===o&&(o=null),d(this,void 0,void 0,function(){var t=this;return G(this,function(e){return console.log("VapaeeDEX.getBalances()"),this.feed.setLoading("balances",!0),[2,this.waitTokensLoaded.then(function(e){return d(t,void 0,void 0,function(){var t;return G(this,function(e){switch(e.label){case 0:return!o&&this.current.name&&(o=this.current.name),o?[4,this.fetchBalances(o)]:[3,2];case 1:t=e.sent(),e.label=2;case 2:return this.balances=t,this.feed.setLoading("balances",!1),[2,this.balances]}})})})]})})},e.prototype.getThisSellOrders=function(l,h){return d(this,void 0,void 0,function(){var t=this;return G(this,function(e){return this.feed.setLoading("thisorders",!0),[2,this.waitTokensLoaded.then(function(e){return d(t,void 0,void 0,function(){var t,o,r,s,n,i,a,u,c;return G(this,function(e){switch(e.label){case 0:for(r in t=[],o=[],h)o.push(r);s=0,e.label=1;case 1:if(!(s<o.length))return[3,4];for(u in n=o[s],i=h[n],a=!1,t)if(t[u].id==i){a=!0;break}return a?[3,3]:[4,this.fetchOrders({scope:l,limit:1,lower_bound:i.toString()})];case 2:c=e.sent(),t=t.concat(c.rows),e.label=3;case 3:return s++,[3,1];case 4:return this.feed.setLoading("thisorders",!1),[2,t]}})})})]})})},e.prototype.getUserOrders=function(u){return void 0===u&&(u=null),d(this,void 0,void 0,function(){var t=this;return G(this,function(e){return console.log("VapaeeDEX.getUserOrders()"),this.feed.setLoading("userorders",!0),[2,this.waitTokensLoaded.then(function(e){return d(t,void 0,void 0,function(){var t,o,r,s,n,i,a;return G(this,function(e){switch(e.label){case 0:return!u&&this.current.name&&(u=this.current.name),u?[4,this.fetchUserOrders(u)]:[3,2];case 1:t=e.sent(),e.label=2;case 2:o=t.rows,r={},s=0,e.label=3;case 3:return s<o.length?(n=o[s].ids,i=o[s].table,[4,this.getThisSellOrders(i,n)]):[3,6];case 4:a=e.sent(),r[i]={table:i,orders:this.auxProcessRowsToOrders(a),ids:n},e.label=5;case 5:return s++,[3,3];case 6:return this.userorders=r,this.feed.setLoading("userorders",!1),[2,this.userorders]}})})})]})})},e.prototype.updateActivity=function(){return d(this,void 0,void 0,function(){var t,o;return G(this,function(e){switch(e.label){case 0:return this.feed.setLoading("activity",!0),t=this.activityPagesize,[4,this.getActivityTotalPages(t)];case 1:return o=e.sent(),[4,Promise.all([this.fetchActivity(o-2,t),this.fetchActivity(o-1,t),this.fetchActivity(o-0,t)])];case 2:return e.sent(),this.feed.setLoading("activity",!1),[2]}})})},e.prototype.loadMoreActivity=function(){return d(this,void 0,void 0,function(){var t,o,r,s;return G(this,function(e){switch(e.label){case 0:return 0==this.activity.list.length?[2]:(this.feed.setLoading("activity",!0),t=this.activityPagesize,o=this.activity.list[this.activity.list.length-1],r=o.id-t,s=Math.floor((r-1)/t),[4,this.fetchActivity(s,t)]);case 1:return e.sent(),this.feed.setLoading("activity",!1),[2]}})})},e.prototype.updateTrade=function(r,s,n){return void 0===n&&(n=!0),d(this,void 0,void 0,function(){var t,o=this;return G(this,function(e){return console.log("VapaeeDEX.updateTrade()"),t="updateTrade",this.feed.startChrono(t),n&&this.updateCurrentUser(),[2,Promise.all([this.getTransactionHistory(r,s,-1,-1,!0).then(function(e){return o.feed.setMarck(t,"getTransactionHistory()")}),this.getBlockHistory(r,s,-1,-1,!0).then(function(e){return o.feed.setMarck(t,"getBlockHistory()")}),this.getSellOrders(r,s,!0).then(function(e){return o.feed.setMarck(t,"getSellOrders()")}),this.getBuyOrders(r,s,!0).then(function(e){return o.feed.setMarck(t,"getBuyOrders()")}),this.getTableSummary(r,s,!0).then(function(e){return o.feed.setMarck(t,"getTableSummary()")}),this.getOrderSummary().then(function(e){return o.feed.setMarck(t,"getOrderSummary()")})]).then(function(e){return o._reverse={},o.resortTokens(),o.onTradeUpdated.next(null),e})]})})},e.prototype.updateCurrentUser=function(){return d(this,void 0,void 0,function(){var t=this;return G(this,function(e){return this.feed.setLoading("current",!0),[2,Promise.all([this.getUserOrders(),this.getDeposits(),this.getBalances()]).then(function(e){return t.feed.setLoading("current",!1),e})["catch"](function(e){throw t.feed.setLoading("current",!1),e})]})})},e.prototype.getBlockHistoryTotalPagesFor=function(e,t){if(!this._markets)return 0;var o=this.market(e);if(!o)return 0;var r=o.blocks,s=r%t,n=(r-s)/t;return 0<s&&(n+=1),n},e.prototype.getHistoryTotalPagesFor=function(e,t){if(!this._markets)return 0;var o=this.market(e);if(!o)return 0;var r=o.deals,s=r%t,n=(r-s)/t;return 0<s&&(n+=1),n},e.prototype.getActivityTotalPages=function(i){return d(this,void 0,void 0,function(){var n=this;return G(this,function(e){return[2,this.contract.getTable("events",{limit:1}).then(function(e){var t=e.rows[0].params,o=parseInt(t.split(" ")[0])-1,r=o%i,s=(o-r)/i;return 0<r&&(s+=1),n.activity.total=o,console.log("VapaeeDEX.getActivityTotalPages() total: ",o," pages: ",s),s})]})})},e.prototype.getTransactionHistory=function(n,i,a,u,c){return void 0===a&&(a=-1),void 0===u&&(u=-1),void 0===c&&(c=!1),d(this,void 0,void 0,function(){var r,t,o,s=this;return G(this,function(e){return r=this.canonicalScope(this.getScopeFor(n,i)),o=null,this.feed.setLoading("history."+r,!0),t=this.waitOrderSummary.then(function(e){return d(s,void 0,void 0,function(){var t,o=this;return G(this,function(e){return-1==u&&(u=10),-1==a&&(t=this.getHistoryTotalPagesFor(r,u),(a=t-3)<0&&(a=0)),[2,Promise.all([this.fetchHistory(r,a+0,u),this.fetchHistory(r,a+1,u),this.fetchHistory(r,a+2,u)]).then(function(e){return o.feed.setLoading("history."+r,!1),o.market(r).history})["catch"](function(e){throw o.feed.setLoading("history."+r,!1),e})]})})}),o=this.market(r)&&!c?this.market(r).history:t,this.onHistoryChange.next(o),[2,o]})})},e.prototype.auxHourToLabel=function(e){var t=new Date(1e3*e*60*60);return 0==t.getHours()?this.datePipe.transform(t,"dd/MM"):t.getHours()+"h"},e.prototype.getBlockHistory=function(s,n,i,a,u){return void 0===i&&(i=-1),void 0===a&&(a=-1),void 0===u&&(u=!1),d(this,void 0,void 0,function(){var v,t,o,r=this;return G(this,function(e){return console.log("VapaeeDEX.getBlockHistory()",s.symbol,i,a),v=this.canonicalScope(this.getScopeFor(s,n)),o=null,this.feed.setLoading("block-history."+v,!0),t=this.waitOrderSummary.then(function(e){return d(r,void 0,void 0,function(){var t,o,r,s,y=this;return G(this,function(e){for(-1==a&&(a=10),-1==i&&(t=this.getBlockHistoryTotalPagesFor(v,a),(i=t-3)<0&&(i=0)),o=[],r=0;r<=t;r++)s=this.fetchBlockHistory(v,r,a),o.push(s);return[2,Promise.all(o).then(function(e){y.feed.setLoading("block-history."+v,!1);var t=y.market(v);t.blocklist=[],t.reverseblocks=[];var o=new Date,r=Math.floor(o.getTime()/36e5),s=null,n=[];for(var i in t.block)n.push(t.block[i]);for(var i in n.sort(function(e,t){return e.hour<t.hour?-11:1}),n){var a,u=n[i],c=y.auxHourToLabel(u.hour);if(s)for(var l=u.hour-s.hour,h=1;h<l;h++){var m=[d=y.auxHourToLabel(s.hour+h),p=s.price.amount.toNumber(),p,p,p];t.blocklist.push(m);m=[d,f=s.inverse.amount.toNumber(),f,f,f];t.reverseblocks.push(m)}(a=[c]).push(u.max.amount.toNumber()),a.push(u.entrance.amount.toNumber()),a.push(u.price.amount.toNumber()),a.push(u.min.amount.toNumber()),t.blocklist.push(a),(a=[c]).push(1/u.max.amount.toNumber()),a.push(1/u.entrance.amount.toNumber()),a.push(1/u.price.amount.toNumber()),a.push(1/u.min.amount.toNumber()),t.reverseblocks.push(a),s=u}if(s&&r!=s.hour)for(l=r-s.hour,h=1;h<=l;h++){var d,p;m=[d=y.auxHourToLabel(s.hour+h),p=s.price.amount.toNumber(),p,p,p];t.blocklist.push(m);var f;m=[d,f=s.inverse.amount.toNumber(),f,f,f];t.reverseblocks.push(m)}return t}).then(function(e){for(var t=[e.blocklist],o=[e.reverseblocks],r=0;256<t[r].length;r++){for(var s=[],n=[],i=[],a=0;a<t[r].length;a+=2){for(var u=t[r][a],c=t[r][a+1],l=(i=[],0);l<5;l++)i[l]=u[l];c&&(i[0]=1<u[0].split("/").length?u[0]:c[0],i[1]=Math.max(u[1],c[1]),i[2]=u[2],i[3]=c[3],i[4]=Math.min(u[4],c[4])),s.push(i),u=o[r][a],c=o[r][a+1],i=[];for(l=0;l<5;l++)i[l]=u[l];c&&(i[0]=1<u[0].split("/").length?u[0]:c[0],i[1]=Math.min(u[1],c[1]),i[2]=u[2],i[3]=c[3],i[4]=Math.max(u[4],c[4])),n.push(i)}t.push(s),o.push(n)}return e.blocklevels=t,e.reverselevels=o,e.block})["catch"](function(e){throw y.feed.setLoading("block-history."+v,!1),e})]})})}),o=this.market(v)&&!u?this.market(v).block:t,this.onHistoryChange.next(o),[2,o]})})},e.prototype.getSellOrders=function(s,n,i){return void 0===i&&(i=!1),d(this,void 0,void 0,function(){var t,h,o,r=this;return G(this,function(e){return t=this.getScopeFor(s,n),h=this.canonicalScope(t),this.inverseScope(h),null,this.feed.setLoading("sellorders",!0),o=this.waitTokensLoaded.then(function(e){return d(r,void 0,void 0,function(){var t,o,r,s,n,i,a,u,c,l;return G(this,function(e){switch(e.label){case 0:return[4,this.fetchOrders({scope:h,limit:100,index_position:"2",key_type:"i64"})];case 1:if(t=e.sent(),this._markets[h]=this.auxAssertScope(h),(o=this.auxProcessRowsToOrders(t.rows)).sort(function(e,t){return e.price.amount.isLessThan(t.price.amount)?-11:e.price.amount.isGreaterThan(t.price.amount)?1:0}),r=[],0<o.length)for(n=0;n<o.length;n++)i=o[n],0<r.length&&(s=r[r.length-1]).price.amount.eq(i.price.amount)?(s.total.amount=s.total.amount.plus(i.total.amount),s.telos.amount=s.telos.amount.plus(i.telos.amount),s.owners[i.owner]=!0,s.orders.push(i)):((s={str:i.price.toString(),price:i.price,orders:[],total:i.total.clone(),telos:i.telos.clone(),inverse:i.inverse,sum:null,sumtelos:null,owners:{}}).owners[i.owner]=!0,s.orders.push(i),r.push(s));for(c in a=new I(0),u=new I(0),r)l=r[c],u=u.plus(l.telos.amount),a=a.plus(l.total.amount),l.sumtelos=new z(u,l.telos.token),l.sum=new z(a,l.total.token);return this._markets[h].orders.sell=r,this.feed.setLoading("sellorders",!1),[2,this._markets[h].orders.sell]}})})}),[2,this._markets[h]&&!i?this._markets[h].orders.sell:o]})})},e.prototype.getBuyOrders=function(s,n,i){return void 0===i&&(i=!1),d(this,void 0,void 0,function(){var t,h,m,o,r=this;return G(this,function(e){return t=this.getScopeFor(s,n),h=this.canonicalScope(t),m=this.inverseScope(h),null,this.feed.setLoading("buyorders",!0),o=this.waitTokensLoaded.then(function(e){return d(r,void 0,void 0,function(){var t,o,r,s,n,i,a,u,c,l;return G(this,function(e){switch(e.label){case 0:return[4,this.fetchOrders({scope:m,limit:50,index_position:"2",key_type:"i64"})];case 1:return[4,e.sent()];case 2:if(t=e.sent(),this._markets[h]=this.auxAssertScope(h),(o=this.auxProcessRowsToOrders(t.rows)).sort(function(e,t){return e.price.amount.isLessThan(t.price.amount)?1:e.price.amount.isGreaterThan(t.price.amount)?-1:0}),r=[],0<o.length)for(n=0;n<o.length;n++)i=o[n],0<r.length&&(s=r[r.length-1]).price.amount.eq(i.price.amount)?(s.total.amount=s.total.amount.plus(i.total.amount),s.telos.amount=s.telos.amount.plus(i.telos.amount),s.owners[i.owner]=!0,s.orders.push(i)):((s={str:i.price.toString(),price:i.price,orders:[],total:i.total.clone(),telos:i.telos.clone(),inverse:i.inverse,sum:null,sumtelos:null,owners:{}}).owners[i.owner]=!0,s.orders.push(i),r.push(s));for(c in a=new I(0),u=new I(0),r)l=r[c],u=u.plus(l.telos.amount),a=a.plus(l.total.amount),l.sumtelos=new z(u,l.telos.token),l.sum=new z(a,l.total.token);return this._markets[h].orders.buy=r,this.feed.setLoading("buyorders",!1),[2,this._markets[h].orders.buy]}})})}),[2,this._markets[h]&&!i?this._markets[h].orders.buy:o]})})},e.prototype.getOrderSummary=function(){return d(this,void 0,void 0,function(){var t,o,r,s;return G(this,function(e){switch(e.label){case 0:return console.log("VapaeeDEX.getOrderSummary()"),[4,this.fetchOrderSummary()];case 1:for(o in(t=e.sent()).rows)r=t.rows[o].table,s=this.canonicalScope(r),console.assert(r==s,"ERROR: scope is not canonical",r,[o,t]),r.split(".")[0].toUpperCase(),r.split(".")[1].toUpperCase(),this._markets[r]=this.auxAssertScope(r),this._markets[r].header.sell.total=new z(t.rows[o].supply.total,this),this._markets[r].header.sell.orders=t.rows[o].supply.orders,this._markets[r].header.buy.total=new z(t.rows[o].demand.total,this),this._markets[r].header.buy.orders=t.rows[o].demand.orders,this._markets[r].deals=t.rows[o].deals,this._markets[r].blocks=t.rows[o].blocks;return this.setOrderSummary(),[2]}})})},e.prototype.getTableSummary=function(U,q,n){return void 0===n&&(n=!1),d(this,void 0,void 0,function(){var j,F,t,V,X,o,r,s=this;return G(this,function(e){switch(e.label){case 0:return j=this.getScopeFor(U,q),F=this.canonicalScope(j),t=this.inverseScope(F),V="0.00000000 "+U.symbol,X="0.00000000 "+q.symbol,this.feed.setLoading("summary."+F,!0),this.feed.setLoading("summary."+t,!0),r=o=null,o=this.waitTokensLoaded.then(function(e){return d(s,void 0,void 0,function(){var t,o,r,s,n,i,a,u,c,l,h,m,d,p,f,y,v,g,k,b,w,_,S,L,T,x,O,R,C,E,P,D,N,A,M,B,H;return G(this,function(e){switch(e.label){case 0:return[4,this.fetchSummary(F)];case 1:for(t=e.sent(),this._markets[F]=this.auxAssertScope(F),this._markets[F].summary={scope:F,price:new z(new I(0),q),price_24h_ago:new z(new I(0),q),inverse:new z(new I(0),U),inverse_24h_ago:new z(new I(0),U),volume:new z(new I(0),q),amount:new z(new I(0),U),percent:.3,records:t.rows},o=new Date,r=Math.floor(o.getTime()/1e3),s=Math.floor(r/3600),n=s-23,i=X,a=V,u={},_=c=0;_<t.rows.length;_++)l=t.rows[_].hour,"lastone"==t.rows[_].label||(u[l]=t.rows[_],c<l&&l<n&&(c=l,i=j==F?t.rows[_].price:t.rows[_].inverse,a=j==F?t.rows[_].inverse:t.rows[_].price));for(h={},m=new z(X,this),d=new z(V,this),p=new z(i,this),f=new z(a,this),y=p.clone(),v=p.clone(),g=f.clone(),k=f.clone(),w=b=null,_=0;_<24;_++)S=n+_,L=new Date(3600*S*1e3),(T=u[S])?(x=j==F?T.price:T.inverse,O=j==F?T.inverse:T.price,R=j==F?T.volume:T.amount,C=j==F?T.amount:T.volume,T.price=x,T.inverse=O,T.volume=R,T.amount=C):T={label:this.auxGetLabelForHour(S%24),price:i,inverse:a,volume:X,amount:V,date:L.toISOString().split(".")[0],hour:S},h[S]=u[S]||T,i=h[S].price,E=new z(h[S].volume,this),console.assert(E.token.symbol==m.token.symbol,"ERROR: different tokens",E.str,m.str),m.amount=m.amount.plus(E.amount),i==X||b||(b=new z(i,this)),p=new z(i,this),console.assert(p.token.symbol==y.token.symbol,"ERROR: different tokens",p.str,y.str),p.amount.isGreaterThan(y.amount)&&(y=p.clone()),console.assert(p.token.symbol==v.token.symbol,"ERROR: different tokens",p.str,v.str),(v.amount.isEqualTo(0)||p.amount.isLessThan(v.amount))&&(v=p.clone()),a=h[S].inverse,P=new z(h[S].amount,this),console.assert(P.token.symbol==d.token.symbol,"ERROR: different tokens",P.str,d.str),d.amount=d.amount.plus(P.amount),a==V||w||(w=new z(a,this)),f=new z(a,this),console.assert(f.token.symbol==g.token.symbol,"ERROR: different tokens",f.str,g.str),f.amount.isGreaterThan(g.amount)&&(g=f.clone()),console.assert(f.token.symbol==k.token.symbol,"ERROR: different tokens",f.str,k.str),(k.amount.isEqualTo(0)||f.amount.isLessThan(k.amount))&&(k=f.clone());return b||(b=new z(h[n].price,this)),D=new z(h[s].price,this),(N=D.clone()).amount=D.amount.minus(b.amount),(A=0)!=b.amount.toNumber()&&(A=N.amount.dividedBy(b.amount).toNumber()),M=Math.floor(1e4*A)/100,w||(w=new z(h[n].inverse,this)),B=new z(h[s].inverse,this),B.clone().amount=B.amount.minus(w.amount),(A=0)!=w.amount.toNumber()&&(A=N.amount.dividedBy(w.amount).toNumber()),H=Math.floor(1e4*A)/100,this._markets[F].summary.price=D,this._markets[F].summary.inverse=B,this._markets[F].summary.price_24h_ago=b||D,this._markets[F].summary.inverse_24h_ago=w,this._markets[F].summary.percent_str=(isNaN(M)?0:M)+"%",this._markets[F].summary.percent=isNaN(M)?0:M,this._markets[F].summary.ipercent_str=(isNaN(H)?0:H)+"%",this._markets[F].summary.ipercent=isNaN(H)?0:H,this._markets[F].summary.volume=m,this._markets[F].summary.amount=d,this._markets[F].summary.min_price=v,this._markets[F].summary.max_price=y,this._markets[F].summary.min_inverse=k,this._markets[F].summary.max_inverse=g,this.feed.setLoading("summary."+F,!1),this.feed.setLoading("summary."+a,!1),[2,this._markets[F].summary]}})})}),!this._markets[F]||n?[3,1]:(r=this._markets[F].summary,[3,3]);case 1:return[4,o];case 2:r=e.sent(),e.label=3;case 3:return this.setMarketSummary(),this.onMarketSummary.next(r),[2,r]}})})},e.prototype.getAllTablesSumaries=function(){return d(this,void 0,void 0,function(){var t=this;return G(this,function(e){return[2,this.waitOrderSummary.then(function(e){return d(t,void 0,void 0,function(){var t,o,r,s=this;return G(this,function(e){for(o in t=[],this._markets)-1!=o.indexOf(".")&&(r=this.getTableSummary(this._markets[o].comodity,this._markets[o].currency,!0),t.push(r));return[2,Promise.all(t).then(function(e){s.updateTokensSummary()})]})})})]})})},e.prototype.auxProcessRowsToOrders=function(e){for(var t=[],o=0;o<e.length;o++){var r,s=new z(e[o].price,this),n=new z(e[o].inverse,this),i=new z(e[o].selling,this),a=new z(e[o].total,this),u=this.getScopeFor(s.token,n.token),c=this.canonicalScope(u);r=this.inverseScope(c)==u?{id:e[o].id,price:s,inverse:n,total:i,deposit:i,telos:a,owner:e[o].owner}:{id:e[o].id,price:n,inverse:s,total:a,deposit:i,telos:i,owner:e[o].owner},t.push(r)}return t},e.prototype.auxGetLabelForHour=function(e){return["h.zero","h.one","h.two","h.three","h.four","h.five","h.six","h.seven","h.eight","h.nine","h.ten","h.eleven","h.twelve","h.thirteen","h.fourteen","h.fifteen","h.sixteen","h.seventeen","h.eighteen","h.nineteen","h.twenty","h.twentyone","h.twentytwo","h.twentythree"][e]},e.prototype.auxAssertScope=function(e){var t=e.split(".")[0].toUpperCase(),o=e.split(".")[1].toUpperCase(),r=this.getTokenNow(t),s=this.getTokenNow(o),n=new z(0,r),i=new z(0,s),a={scope:e,price:i,price_24h_ago:i,inverse:n,inverse_24h_ago:n,max_inverse:n,max_price:i,min_inverse:n,min_price:i,records:[],volume:i,amount:n,percent:0,ipercent:0,percent_str:"0%",ipercent_str:"0%"};return this._markets[e]||{scope:e,comodity:r,currency:s,orders:{sell:[],buy:[]},deals:0,history:[],tx:{},blocks:0,block:{},blocklist:[],blocklevels:[[]],reverseblocks:[],reverselevels:[[]],summary:a,header:{sell:{total:n,orders:0},buy:{total:i,orders:0}}}},e.prototype.fetchDeposits=function(e){return this.contract.getTable("deposits",{scope:e}).then(function(e){return e})},e.prototype.fetchBalances=function(c){return d(this,void 0,void 0,function(){var t=this;return G(this,function(e){return[2,this.waitTokensLoaded.then(function(e){return d(t,void 0,void 0,function(){var t,o,r,s,n,i,a,u;return G(this,function(e){switch(e.label){case 0:for(u in t={},o=[],this.tokens)this.tokens[u].offchain||(t[this.tokens[u].contract]=!0);for(i in t)this.feed.setLoading("balances-"+i,!0);for(s in r=[],t)r.push(s);n=0,e.label=1;case 1:return n<r.length?(i=r[n],[4,this.contract.getTable("accounts",{contract:i,scope:c||this.current.name})]):[3,4];case 2:for(u in(a=e.sent()).rows)o.push(new z(a.rows[u].balance,this));this.feed.setLoading("balances-"+i,!1),e.label=3;case 3:return n++,[3,1];case 4:return[2,o]}})})})]})})},e.prototype.fetchOrders=function(e){return this.contract.getTable("sellorders",e).then(function(e){return e})},e.prototype.fetchOrderSummary=function(){return this.contract.getTable("ordersummary").then(function(e){return e})},e.prototype.fetchBlockHistory=function(e,t,o){var r=this;void 0===t&&(t=0),void 0===o&&(o=25);var s=this.canonicalScope(e),n=t*o;if(t<this.getBlockHistoryTotalPagesFor(s,o)&&this._markets&&this._markets[s]&&this._markets[s].block["id-"+n]){for(var i={more:!1,rows:[]},a=0;a<o;a++){var u=n+a,c=this._markets[s].block["id-"+u];if(!c)break;i.rows.push(c)}if(i.rows.length==o)return Promise.resolve(i)}return this.contract.getTable("blockhistory",{scope:s,limit:o,lower_bound:""+t*o}).then(function(e){r._markets[s]=r.auxAssertScope(s),r._markets[s].block=r._markets[s].block||{};for(var t=0;t<e.rows.length;t++){var o={id:e.rows[t].id,hour:e.rows[t].hour,str:"",price:new z(e.rows[t].price,r),inverse:new z(e.rows[t].inverse,r),entrance:new z(e.rows[t].entrance,r),max:new z(e.rows[t].max,r),min:new z(e.rows[t].min,r),volume:new z(e.rows[t].volume,r),amount:new z(e.rows[t].amount,r),date:new Date(e.rows[t].date)};o.str=JSON.stringify([o.max.str,o.entrance.str,o.price.str,o.min.str]),r._markets[s].block["id-"+o.id]=o}return e})},e.prototype.fetchHistory=function(e,t,o){var s=this;void 0===t&&(t=0),void 0===o&&(o=25);var n=this.canonicalScope(e),r=t*o;if(t<this.getHistoryTotalPagesFor(n,o)&&this._markets&&this._markets[n]&&this._markets[n].tx["id-"+r]){for(var i={more:!1,rows:[]},a=0;a<o;a++){var u=r+a,c=this._markets[n].tx["id-"+u];if(!c)break;i.rows.push(c)}if(i.rows.length==o)return Promise.resolve(i)}return this.contract.getTable("history",{scope:e,limit:o,lower_bound:""+t*o}).then(function(e){s._markets[n]=s.auxAssertScope(n),s._markets[n].history=[],s._markets[n].tx=s._markets[n].tx||{};for(var t=0;t<e.rows.length;t++){var o={id:e.rows[t].id,str:"",amount:new z(e.rows[t].amount,s),payment:new z(e.rows[t].payment,s),buyfee:new z(e.rows[t].buyfee,s),sellfee:new z(e.rows[t].sellfee,s),price:new z(e.rows[t].price,s),inverse:new z(e.rows[t].inverse,s),buyer:e.rows[t].buyer,seller:e.rows[t].seller,date:new Date(e.rows[t].date),isbuy:!!e.rows[t].isbuy};o.str=o.price.str+" "+o.amount.str,s._markets[n].tx["id-"+o.id]=o}for(var r in s._markets[n].tx)s._markets[n].history.push(s._markets[n].tx[r]);return s._markets[n].history.sort(function(e,t){return e.date<t.date?1:e.date>t.date?-1:e.id<t.id?1:e.id>t.id?-1:void 0}),e})},e.prototype.fetchActivity=function(i,a){return void 0===i&&(i=0),void 0===a&&(a=25),d(this,void 0,void 0,function(){var t,o,r,s,n=this;return G(this,function(e){if(t=i*a+1,this.activity.events["id-"+t]){for(o=[],r=0;r<a&&(s=t+r,this.activity.events["id-"+s]);r++);if(o.length==a)return[2]}return[2,this.contract.getTable("events",{limit:a,lower_bound:""+t}).then(function(e){for(var t=[],o=0;o<e.rows.length;o++){var r=e.rows[o].id,s=e.rows[o];n.activity.events["id-"+r]||(n.activity.events["id-"+r]=s,t.push(s))}n.activity.list=[].concat(n.activity.list).concat(t),n.activity.list.sort(function(e,t){return e.date<t.date?1:e.date>t.date?-1:e.id<t.id?1:e.id>t.id?-1:void 0})})]})})},e.prototype.fetchUserOrders=function(e){return this.contract.getTable("userorders",{scope:e,limit:200}).then(function(e){return e})},e.prototype.fetchSummary=function(e){return this.contract.getTable("tablesummary",{scope:e}).then(function(e){return e})},e.prototype.fetchTokenStats=function(t){var o=this;return this.feed.setLoading("token-stat-"+t.symbol,!0),this.contract.getTable("stat",{contract:t.contract,scope:t.symbol}).then(function(e){return t.stat=e.rows[0],t.stat.issuers&&"everyone"==t.stat.issuers[0]&&(t.fake=!0),o.feed.setLoading("token-stat-"+t.symbol,!1),t})},e.prototype.fetchTokensStats=function(e){var r=this;return void 0===e&&(e=!0),console.log("Vapaee.fetchTokens()"),this.feed.setLoading("token-stats",!0),this.waitTokensLoaded.then(function(e){var t=[];for(var o in r.tokens)r.tokens[o].offchain||t.push(r.fetchTokenStats(r.tokens[o]));return Promise.all(t).then(function(e){return r.setTokenStats(r.tokens),r.feed.setLoading("token-stats",!1),r.tokens})})},e.prototype.updateTokensMarkets=function(){var n=this;return Promise.all([this.waitTokensLoaded,this.waitMarketSummary]).then(function(e){for(var t in n.tokens)if(!n.tokens[t].offchain){var o=n.tokens[t];new z(0,o);for(var r in o.markets=[],n._markets)if(-1!=r.indexOf(".")){var s=n._markets[r];s.currency.symbol==o.symbol&&(s=n.market(n.inverseScope(r))),s.comodity.symbol==o.symbol&&o.markets.push(s)}}o.markets.sort(function(e,t){var o=e.summary?e.summary.volume:new z,r=t.summary?t.summary.volume:new z;return o.amount.isGreaterThan(r.amount)?-1:o.amount.isLessThan(r.amount)?1:0})})},e.prototype.updateTokensSummary=function(e){var _=this;if(void 0===e&&(e=20),!(1<e))return Promise.all([this.waitTokensLoaded,this.waitMarketSummary]).then(function(e){var t={};for(var o in _.tokens)if(!_.tokens[o].offchain){var r=_.tokens[o],s=new z(0,r);for(var n in _._markets){if(-1!=n.indexOf("."))(h=_._markets[n]).comodity.symbol==r.symbol&&(s=s.plus(h.summary.amount)),h.currency.symbol==r.symbol&&(s=s.plus(h.summary.volume)),h.comodity.symbol==r.symbol&&h.currency.symbol==_.telos.symbol&&(r.summary&&0==r.summary.price.amount.toNumber()&&delete r.summary,r.summary=r.summary||{price:h.summary.price.clone(),price_24h_ago:h.summary.price_24h_ago.clone(),volume:h.summary.volume.clone(),percent:h.summary.percent,percent_str:h.summary.percent_str})}r.summary=r.summary||{price:new z(0,_.telos),price_24h_ago:new z(0,_.telos),volume:new z(0,_.telos),percent:0,percent_str:"0%"},t[r.symbol]=s}_.telos.summary={price:new z(1,_.telos),price_24h_ago:new z(1,_.telos),volume:new z(-1,_.telos),percent:0,percent_str:"0%"};var i=new I(1);for(var o in _.tokens){if(!(r=_.tokens[o]).offchain&&(r.summary&&r.symbol!=_.telos.symbol)){var a=new z(0,_.telos),u=new z(0,_.telos),c=new z(0,_.telos),l=t[r.symbol];if(0!=l.toNumber()){for(var n in _._markets)if(-1!=n.indexOf(".")){var h;"TLOS"==(h=_._markets[n]).currency.symbol||h.currency.summary.price.amount,"TLOS"==h.currency.symbol||h.currency.summary.price_24h_ago.amount;if(h.comodity.symbol==r.symbol||h.currency.symbol==r.symbol){s=new z;h.comodity.symbol==r.symbol?s=h.summary.amount.clone():h.currency.symbol==r.symbol&&(s=h.summary.volume.clone());var m,d=s.amount.dividedBy(l.amount);h.comodity.symbol==r.symbol?m=h.summary.price.amount.multipliedBy(h.currency.summary.price.amount):h.currency.symbol==r.symbol&&(m=h.summary.inverse.amount.multipliedBy(h.comodity.summary.price.amount));var p,f=new z(m.multipliedBy(d),_.telos);h.comodity.symbol==r.symbol?p=h.summary.price_24h_ago.amount.multipliedBy(h.currency.summary.price_24h_ago.amount):h.currency.symbol==r.symbol&&(p=h.summary.inverse_24h_ago.amount.multipliedBy(h.comodity.summary.price_24h_ago.amount));var y,v=new z(p.multipliedBy(d),_.telos);h.comodity.symbol==r.symbol?y=h.summary.volume.clone():h.currency.symbol==r.symbol&&(y=h.summary.amount.clone()),y.token.symbol!=_.telos.symbol&&(y=new z(s.amount.multipliedBy(s.token.summary.price.amount),_.telos)),u=u.plus(new z(f,_.telos)),c=c.plus(new z(v,_.telos)),a=a.plus(new z(y,_.telos))}}var g=u.minus(c),k=0;0!=c.amount.toNumber()&&(k=g.amount.dividedBy(c.amount).toNumber());var b=Math.floor(1e4*k)/100,w=(isNaN(b)?0:b)+"%";r.summary.price=u,r.summary.price_24h_ago=c,r.summary.percent=b,r.summary.percent_str=w,r.summary.volume=a}}}_.resortTokens(),_.setTokenSummary()});for(var t=e;0<t;t--)this.updateTokensSummary(1)},e.prototype.fetchTokens=function(e){var r=this;return void 0===e&&(e=!0),console.log("Vapaee.fetchTokens()"),this.contract.getTable("tokens").then(function(e){var t={tokens:e.rows};for(var o in t.tokens)t.tokens[o].scope=t.tokens[o].symbol.toLowerCase()+".tlos","TLOS"==t.tokens[o].symbol&&(r.telos=t.tokens[o]);return t})},e.prototype.resortTokens=function(){this.tokens.sort(function(e,t){if(e.offchain)return 1;if(t.offchain)return-1;var o=e.summary?e.summary.volume:new z,r=t.summary?t.summary.volume:new z;return o.amount.isGreaterThan(r.amount)?-1:o.amount.isLessThan(r.amount)?1:e.appname<t.appname?-1:e.appname>t.appname?1:0}),this.onTokensReady.next(this.tokens)},e.decorators=[{type:o.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:t.VapaeeScatter},{type:r.CookieService},{type:s.DatePipe}]},e.ngInjectableDef=o.defineInjectable({factory:function(){return new e(o.inject(t.VapaeeScatter),o.inject(a.CookieService),o.inject(s.DatePipe))},token:e,providedIn:"root"}),e}(),m=function(){function e(){}return e.decorators=[{type:o.NgModule,args:[{imports:[],declarations:[],providers:[h],exports:[]}]}],e}();e.VapaeeDEX=h,e.VapaeeDexModule=m,e.TokenDEX=l,e.AssetDEX=z,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=vapaee-dex.umd.min.js.map